# 스레드보다는 실행자, 태스크, 스트림을 애용하라

## 실행자와 태스크

`java.util.concurrent` 패키지의 등장으로 실행자 프레임워크(Executor Framework)라고 하는 인터페이스 기반의 유연한 태스크 실행 기능을 사용할 수 있게 되었다.

아래 코드 단 한줄로 작업 큐를 생성할 수 있게 되었다. (책에서는 실행자라고 부름)
`ExecutorService exec = Executors.newSingleThreadExecutor()`

이렇게 만든 실행자에게 실행할 태스크를 넘기기만 하면 된다.

`exec.execute(runnable)`

아래 코드를 통해서 실행자를 우아하게(?) 종료시킬 수 있다.(이 작업에 실패한다면 VM 자체가 종료되지 않는다.)

`exec.shutdown()`

## 실행자 서비스의 주요기능

이런 실행자 기반의 서비스에는 아래와 같은 주요 기능들이 있다

특정 태스크가 완료되기를 기다린다.
- 아이템 79에서 봤던 코드를 참고하자 `exec.submit(() -> s.removeObserver(this)).get();`

태스크 모음 중 아무것 하나(invokeAny 메소드) 혹은 모든 태스크(invokeAll 메소드)가 완료되기를 기다린다.

실행자 서비스가 종료하기를 기다린다(awaitTermination 메서드)

완료된 태스크들의 결과를 차례로 받는다(ExecutorCompletionService)

태스크를 특정 시간에 혹은 주기적으로 실행하게 한다(ScheduledThreadPoolExecutor)

## 둘 이상의 쓰레드가 처리하는 실행자 - 스레드 풀 실행자

실행 큐를 둘 이상의 스레드가 처리하게 하고 싶다면 `스레드 풀 실행자(ThreadPoolExecutor)`를 사용하면 된다.

스레드 풀의 스레드 개수는 고정할 수도 있고 필요에 따라 늘어나거나 줄어들게 설정할 수도 있다.

특수한 실행자가 필요하다면 ThreadPoolExecutor를 직정 사용해도 된다.

일반적으로는 아래처럼 Java에서 목적에 맞게 쓰레드 풀 실행자를 구현해 두었다. 하나씩 살펴보자.

### CachedThreadPool

작은 프래그램이나 가벼운 서버라면 `Executors.newCachedThreadPool`이 일반적으로 좋은 선택이다.
특별히 설정할 게 없고 일반적인 용도에 적합하다.(무거운 프로덕션 서버에서는 비추!)

`Executors.newCachedThreadPool`에서는 요청받은 태스크들이 큐에 쌓이지 않고 즉시 스레드에 위임돼 실행된다.

가용할 스레드가 없다면 새로 하나를 생성한다.

서버가 아주 무겁다면 CPU 이용률이 100%로 치닫고, 새로운 태스크가 도착하는 족족 또다른 스레드를 생성하며 더욱 상황이 악화된다.

### FixedThreadPool

무거운 프로덕션 서버에서는 스레드 개수를 고정한 `Executors.newFixedThreadPool`을 사용하는게 좋다.

## 실행자 프레임워크의 장점

작업 큐를 손수 만드는 일은 삼가야 하고, 스레드를 직접 다루는 것도 일반적으로 삼가야 한다. 스레드를 직접 다루면 Thread가 작업 단위와 수행 매커니즘 역할을 모두 수행하게 된다. (책임분리가 안됨!)

반면에 실행자 프레임워크에서는 작업 단위와 실행 매커니즘이 분리된다. 여기서 말하는 작업 단위의 추상 개념이 태스크이다.
- 태스크의 종류에는 `Runnable`과 그 사촌격인 `Callable`이 있다. (`Callable`은 값을 반환하고 임의의 예외를 던질 수 있다!)

태스크를 수행하는 주체로서 실행자 서비스가 존재하게 된다.

이런 책임의 분리를 통해서 원하는 실행자 정책을 언제든지 변경할 수 있게 된다.

## 포크-조인(fork-join)과 자바 병렬프로그래밍

자바 7버전 이후로 `포크-조인 태스크`가 등장했으며 포크-조인 태스크는 `포크-조인 풀`이라는 특별한 실행자 서비스가 실행해준다.

포크-조인 태스크(ForJoinTask)의 인스턴스는 작은 하위 태스크로 나뉠 수 있고, ForkJoinPool을 구성하는 스레드들이 이 태스크들을 처리한다.

일을 먼저 끝낸 스레드는 다른 스레드의 남은 태스크를 가져와 대신 처리할 수도 있다.

이렇게 해서 모든 스레드가 바쁘게 움직여 CPU를 최대한 활용하면서 높은 처리량과 낮은 지연시간을 달성한다.

포크-조인을 사용하고 튜닝하는건 어려운 일이지만 포크-조인을 사용해 만든 병령 스트림을 이용하면 적은 노력으로 그 이점을 얻을 수 있다.
(물론 포크-조인에 적합한 작업이어야 한다!)

실행자 프레임워크 기능에 관심이 많다면 `자바 병렬 프로그래밍(에이콘출판사, 2008)`을 참고하자.


